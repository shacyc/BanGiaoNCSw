SELECT ep.pupilid,ep.fullname
   ,DECODE(gender,0,'Nam','N?') GIOI_TINH
  ,TO_CHAR(BIRTHDAY,'DD/MM/YYYY') NGAY_SINH
  ,es.schoolname
  ,esn.schoolclassname
  FROM SAMS.EDU_PUPIL EP
  JOIN SAMS.EDU_PUPIL_STUDYTIMELINE EPS
  ON EP.PUPILID = EPS.PUPILID
  AND EPS.SCHOOLID = EP.CURRENTSCHOOLID
  AND EPS.CURRENTPUPILSTATUSID = 1 
  AND EPS.SCHOOLYEARID = 21
  AND EPS.SCHOOLTERMID = 2
  AND EPS.ISACTIVE = 1 AND EPS.ISDELETED = 0
  LEFT JOIN SAMS.EDU_SCHOOL ES
  ON ES.SCHOOLID = EP.CURRENTSCHOOLID
  AND ES.ISACTIVE = 1 AND ES.ISDELETED = 0
  LEFT JOIN SAMS.EDU_SCHOOLCLASS_NEW ESN
  ON ESN.SCHOOLCLASSID = EP.CURRENTSCHOOLCLASSID
  AND ESN.SCHOOLYEARID = EPS.SCHOOLYEARID
  AND ESN.SCHOOLTERMID = EPS.SCHOOLTERMID
  AND ESN.ISACTIVE = 1 AND ESN.ISDELETED = 0
  JOIN SAMS.EDU_SCHOOL_EDUCATIONLEVEL ESE
  ON ESE.SCHOOLID = ES.SCHOOLID
  AND ESE.EDUCATIONLEVELID IN (4,7)
  WHERE EP.ISACTIVE = 1 AND EP.ISDELETED = 0
  AND EP.CURRENTPUPILSTATUSID = 1 
  AND EP.CURRENTCLASSID IN (15,18)
  AND ES.schoolid NOT IN (1592,1593,1594,1595,1596,1597,1598,1599,1600,1605,1607,1610,1618,1613,1614,1616,1608,1611,1615,1602,1603,1604,1609,1617,1601,1606,1612,1524,1530,10112318,1525,1515,1470,1528,1469)
  AND ep.idcard IS NULL 
  GROUP BY ep.pupilid,ep.fullname,ep.birthday,ep.firstname,ep.lastname,es.schoolname,esn.schoolclassname,ep.gender,ep.idcard
  
  ORDER BY es.schoolname,esn.schoolclassname
  ,NLSSORT(NLS_LOWER(FIRSTNAME, 'NLS_SORT=vietnamese'), 'NLS_SORT=vietnamese'),
                NLSSORT(NLS_LOWER(LASTNAME, 'NLS_SORT=vietnamese'), 'NLS_SORT=vietnamese')
 ;


